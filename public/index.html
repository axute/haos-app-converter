<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HA Add-on Converter (PHP)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü™Ñ</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .converter-container { max-width: 600px; margin: 50px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .step { display: none; }
        .step.active { display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="converter-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">HA Add-on Converter</h2>
            <button type="button" id="cancelBtn" class="btn btn-sm btn-outline-danger" style="display:none;" onclick="cancelConverter()">Abbrechen</button>
        </div>
        
        <div id="addonSelection" class="mb-4">
            <h4>Existierende Add-ons</h4>
            <div id="addonList" class="list-group mb-3">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
            <div class="d-flex justify-content-between">
                <div>
                    <button type="button" class="btn btn-outline-primary" onclick="startNew()">Neues Add-on erstellen</button>
                    <button type="button" class="btn btn-outline-success" onclick="selfConvert()">Converter als Add-on erstellen</button>
                </div>
                <button type="button" class="btn btn-outline-secondary" onclick="openSettings()">‚öôÔ∏è Settings</button>
            </div>
            <hr>
        </div>

        <form id="converterForm" style="display:none;">
            <!-- Einziger Schritt: Alle Informationen -->
            <div id="converterContent">
                <h4>Add-on Informationen</h4>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="name" class="form-label">Add-on Name</label>
                        <input type="text" class="form-control" id="name" required placeholder="z.B. My Awesome Tool">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="version" class="form-label">Version</label>
                        <input type="text" class="form-control" id="version" value="1.0.0">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="description" class="form-label">Beschreibung</label>
                    <textarea class="form-control" id="description" rows="2"></textarea>
                </div>

                <div class="mb-3">
                    <label for="image" class="form-label">Docker Image Name</label>
                    <input type="text" class="form-control" id="image" required placeholder="z.B. nginx:latest oder alpine:3.14">
                    <div class="form-text">Das Image, das als Basis f√ºr das Add-on dienen soll.</div>
                </div>

                <div class="mb-3">
                    <label for="icon_file" class="form-label">Icon Datei (PNG)</label>
                    <input type="file" class="form-control" id="icon_file" accept="image/png">
                    <div id="icon_preview" class="mt-2" style="display:none;">
                        <img src="" alt="Preview" style="max-width: 64px; max-height: 64px;">
                    </div>
                </div>

                <hr>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="ingress">
                    <label class="form-check-label" for="ingress">
                        Home Assistant Ingress aktivieren
                    </label>
                </div>

                <div id="ingressOptions" style="display:none;" class="p-3 border rounded mb-3 bg-light">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ingress_port" class="form-label">Interner Web-Port (Ingress)</label>
                            <input type="number" class="form-control" id="ingress_port" value="80">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="panel_icon" class="form-label">Panel Icon (MDI)</label>
                            <input type="text" class="form-control" id="panel_icon" placeholder="mdi:link-variant">
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="ingress_stream">
                        <label class="form-check-label" for="ingress_stream">
                            Ingress Stream aktivieren
                        </label>
                    </div>
                </div>

                <div id="webUiPortContainer" class="mb-3">
                    <label for="web_ui_port" class="form-label">Web-UI Port (ohne Ingress)</label>
                    <input type="number" class="form-control" id="web_ui_port" placeholder="z.B. 8080">
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="backup">
                    <label class="form-check-label" for="backup">
                        Backup-Unterst√ºtzung aktivieren
                    </label>
                </div>

                <hr>

                <div class="mb-3">
                    <h5>Umgebungsvariablen</h5>
                    <div id="envVarsContainer">
                        <!-- Dynamische Env-Variablen -->
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addEnvVar()">+ Variable hinzuf√ºgen</button>
                </div>

                <div class="mb-3">
                    <h5>Port-Mappings</h5>
                    <div id="portsContainer">
                        <!-- Dynamische Port-Mappings -->
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addPortMapping()">+ Port-Mapping hinzuf√ºgen</button>
                </div>

                <div class="mb-3">
                    <h5>Speicher-Mappings (Map)</h5>
                    <div id="mapContainer">
                        <!-- Dynamische Map-Mappings -->
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addMapMapping()">+ Mapping hinzuf√ºgen</button>
                    <div class="form-text">Erlaubt den Zugriff auf HA-Ordner (z.B. config, ssl, share, media).</div>
                </div>

                <hr>
                
                <div id="submitSection" class="d-grid gap-2">
                    <button type="submit" id="saveBtn" class="btn btn-success btn-lg">Add-on Erstellen / Speichern</button>
                </div>

                <div id="updateSection" style="display:none;">
                    <label class="form-label d-block mb-2">Add-on aktualisieren (Version-Update)</label>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <button type="button" class="btn btn-primary w-100" onclick="submitUpdate('major')">Major-Update</button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-info w-100" onclick="submitUpdate('minor')">Minor-Update</button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-success w-100" onclick="submitUpdate('fix')">Fix-Update</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div id="result" class="mt-4" style="display:none;">
            <!-- Wird dynamisch bef√ºllt -->
        </div>

        <!-- Global Settings View -->
        <div id="settingsView" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4>Globale Repository-Einstellungen</h4>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="closeSettings()">Zur√ºck</button>
            </div>
            <form id="settingsForm">
                <div class="mb-3">
                    <label for="repo_name" class="form-label">Repository Name</label>
                    <input type="text" class="form-control" id="repo_name" required>
                    <div class="form-text">Der Name deines Home Assistant Add-on Repositories.</div>
                </div>
                <div class="mb-3">
                    <label for="repo_maintainer" class="form-label">Maintainer</label>
                    <input type="text" class="form-control" id="repo_maintainer" required>
                    <div class="form-text">Dein Name oder Pseudonym als Maintainer.</div>
                </div>
                <button type="submit" class="btn btn-primary">Einstellungen speichern</button>
            </form>
            <div id="settingsResult" class="mt-3" style="display:none;">
                <div class="alert alert-success">Einstellungen gespeichert!</div>
            </div>
        </div>
    </div>
</div>

<script>
    let iconBase64 = '';
    let isEditing = false;
    let originalVersion = '1.0.0';

    document.getElementById('icon_file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                iconBase64 = event.target.result;
                document.getElementById('icon_preview').style.display = 'block';
                document.getElementById('icon_preview').querySelector('img').src = iconBase64;
            };
            reader.readAsDataURL(file);
        }
    });

    function addEnvVar(key = '', value = '', userEditable = false) {
        const container = document.getElementById('envVarsContainer');
        const div = document.createElement('div');
        div.className = 'input-group mb-2 env-var-row';
        div.innerHTML = `
            <input type="text" class="form-control env-key" placeholder="KEY" value="${key}">
            <input type="text" class="form-control env-value" placeholder="VALUE" value="${value}">
            <div class="input-group-text">
                <input class="form-check-input mt-0 env-user-editable" type="checkbox" title="Vom HA-Benutzer √§nderbar" ${userEditable ? 'checked' : ''}>
                <span class="ms-1 small">HA-Edit</span>
            </div>
            <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">√ó</button>
        `;
        container.appendChild(div);
    }

    function getEnvVars() {
        const rows = document.querySelectorAll('.env-var-row');
        const vars = [];
        rows.forEach(row => {
            const key = row.querySelector('.env-key').value.trim();
            const value = row.querySelector('.env-value').value;
            const userEditable = row.querySelector('.env-user-editable').checked;
            if (key) {
                vars.push({ key, value, userEditable });
            }
        });
        return vars;
    }

    function addPortMapping(containerPort = '', hostPort = '') {
        const container = document.getElementById('portsContainer');
        const div = document.createElement('div');
        div.className = 'input-group mb-2 port-mapping-row';
        div.innerHTML = `
            <input type="number" class="form-control port-container" placeholder="Container Port" value="${containerPort}">
            <span class="input-group-text">‚Üí</span>
            <input type="number" class="form-control port-host" placeholder="Host Port" value="${hostPort}">
            <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">√ó</button>
        `;
        container.appendChild(div);
    }

    function getPortMappings() {
        const rows = document.querySelectorAll('.port-mapping-row');
        const ports = [];
        rows.forEach(row => {
            const container = row.querySelector('.port-container').value;
            const host = row.querySelector('.port-host').value;
            if (container && host) {
                ports.push({ container: parseInt(container), host: parseInt(host) });
            }
        });
        return ports;
    }

    function addMapMapping(folder = 'config', mode = 'rw') {
        const container = document.getElementById('mapContainer');
        const div = document.createElement('div');
        div.className = 'input-group mb-2 map-row';
        div.innerHTML = `
            <select class="form-select map-folder">
                <option value="config" ${folder === 'config' ? 'selected' : ''}>config</option>
                <option value="ssl" ${folder === 'ssl' ? 'selected' : ''}>ssl</option>
                <option value="share" ${folder === 'share' ? 'selected' : ''}>share</option>
                <option value="media" ${folder === 'media' ? 'selected' : ''}>media</option>
                <option value="addons" ${folder === 'addons' ? 'selected' : ''}>addons</option>
                <option value="backup" ${folder === 'backup' ? 'selected' : ''}>backup</option>
            </select>
            <select class="form-select map-mode" style="max-width: 100px;">
                <option value="rw" ${mode === 'rw' ? 'selected' : ''}>RW</option>
                <option value="ro" ${mode === 'ro' ? 'selected' : ''}>RO</option>
            </select>
            <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">√ó</button>
        `;
        container.appendChild(div);
    }

    function getMapMappings() {
        const rows = document.querySelectorAll('.map-row');
        const maps = [];
        rows.forEach(row => {
            const folder = row.querySelector('.map-folder').value;
            const mode = row.querySelector('.map-mode').value;
            maps.push(`${folder}:${mode}`);
        });
        return maps;
    }

    document.getElementById('ingress').addEventListener('change', (e) => {
        document.getElementById('ingressOptions').style.display = e.target.checked ? 'block' : 'none';
        document.getElementById('webUiPortContainer').style.display = e.target.checked ? 'none' : 'block';
    });

    async function submitUpdate(type) {
        let parts = originalVersion.split('.').map(x => parseInt(x) || 0);
        while (parts.length < 3) parts.push(0);

        if (type === 'major') {
            parts[0]++;
            parts[1] = 0;
            parts[2] = 0;
        } else if (type === 'minor') {
            parts[1]++;
            parts[2] = 0;
        } else if (type === 'fix') {
            parts[2]++;
        }

        const newVersion = parts.join('.');
        document.getElementById('version').value = newVersion;
        
        // Formular absenden
        document.getElementById('converterForm').dispatchEvent(new Event('submit'));
    }

    document.getElementById('converterForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            name: document.getElementById('name').value,
            description: document.getElementById('description').value,
            icon_file: iconBase64,
            image: document.getElementById('image').value,
            version: document.getElementById('version').value,
            ingress: document.getElementById('ingress').checked,
            ingress_port: parseInt(document.getElementById('ingress_port').value),
            ingress_stream: document.getElementById('ingress_stream').checked,
            panel_icon: document.getElementById('panel_icon').value || 'mdi:link-variant',
            webui_port: document.getElementById('web_ui_port').value ? parseInt(document.getElementById('web_ui_port').value) : null,
            backup: document.getElementById('backup').checked,
            ports: getPortMappings(),
            map: getMapMappings(),
            env_vars: getEnvVars()
        };

        const response = await fetch('/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.status === 'success') {
            const summary = `
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-success">Erfolg!</h5>
                        <p class="card-text">Add-on wurde erstellt/aktualisiert.</p>
                        <p class="mb-0"><strong>Pfad:</strong> <code id="resultPath">${result.path}</code></p>
                    </div>
                </div>
            `;
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = summary;
            resultDiv.style.display = 'block';
            document.getElementById('converterForm').style.display = 'none';
            document.getElementById('addonSelection').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
            setTimeout(() => location.reload(), 3000); // Reload nach 3 Sekunden um Liste zu aktualisieren
        } else {
            alert('Fehler: ' + result.message);
        }
    });

    async function loadAddons() {
        const response = await fetch('/addons');
        const addons = await response.json();
        const list = document.getElementById('addonList');
        if (addons.length === 0) {
            list.innerHTML = '<div class="list-group-item">Keine Add-ons gefunden</div>';
            return;
        }
        list.innerHTML = addons.map(addon => {
            const isSelf = addon.slug === 'haos_addon_converter';
            const iconHtml = addon.has_local_icon 
                ? `<img src="/addons/${addon.slug}/icon.png" style="width: 24px; height: 24px;" class="me-2">` 
                : '';
            return `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="me-3 text-center" style="width: 40px; font-size: 24px;">
                        ${addon.has_local_icon 
                            ? `<img src="/addons/${addon.slug}/icon.png" style="width: 32px; height: 32px;">` 
                            : 'üì¶'} 
                    </div>
                    <div>
                        <strong>${addon.name}</strong><br>
                        <small class="text-muted">Version: ${addon.version}</small>
                    </div>
                </div>
                ${isSelf ? 
                    '<span class="badge bg-secondary rounded-pill">System</span>' : 
                    `<div>
                        <button type="button" class="btn btn-sm btn-primary rounded-pill" onclick="editAddon('${addon.slug}')">Edit</button>
                        <button type="button" class="btn btn-sm btn-outline-danger rounded-pill" onclick="deleteAddon('${addon.slug}')">L√∂schen</button>
                    </div>`
                }
            </div>
        `}).join('');
    }

    function startNew() {
        isEditing = false;
        document.getElementById('addonSelection').style.display = 'none';
        document.getElementById('converterForm').style.display = 'block';
        document.getElementById('cancelBtn').style.display = 'block';
        
        document.getElementById('submitSection').style.display = 'grid';
        document.getElementById('updateSection').style.display = 'none';
        document.getElementById('version').readOnly = false;

        document.getElementById('converterForm').reset();
        iconBase64 = '';
        document.getElementById('icon_preview').style.display = 'none';
        document.getElementById('icon_preview').querySelector('img').src = '';
        document.getElementById('ingressOptions').style.display = 'none';
        document.getElementById('webUiPortContainer').style.display = 'block';
        document.getElementById('web_ui_port').value = '';
        document.getElementById('panel_icon').value = 'mdi:link-variant';
        document.getElementById('envVarsContainer').innerHTML = '';
        document.getElementById('portsContainer').innerHTML = '';
        document.getElementById('mapContainer').innerHTML = '';
    }

    function cancelConverter() {
        if (confirm('M√∂chtest du den Vorgang wirklich abbrechen? Alle nicht gespeicherten √Ñnderungen gehen verloren.')) {
            document.getElementById('addonSelection').style.display = 'block';
            document.getElementById('converterForm').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
            loadAddons();
        }
    }

    async function editAddon(slug) {
        isEditing = true;
        const response = await fetch(`/addons/${slug}`);
        const addon = await response.json();
        
        document.getElementById('name').value = addon.name;
        document.getElementById('description').value = addon.description;
        
        iconBase64 = addon.icon_file || '';
        if (iconBase64) {
            document.getElementById('icon_preview').style.display = 'block';
            document.getElementById('icon_preview').querySelector('img').src = iconBase64;
        } else {
            document.getElementById('icon_preview').style.display = 'none';
        }

        document.getElementById('image').value = addon.image;
        document.getElementById('version').value = addon.version;
        originalVersion = addon.version || '1.0.0';
        document.getElementById('version').readOnly = true;

        document.getElementById('submitSection').style.display = 'none';
        document.getElementById('updateSection').style.display = 'block';
        document.getElementById('ingress').checked = addon.ingress;
        document.getElementById('ingress_port').value = addon.ingress_port;
        document.getElementById('ingress_stream').checked = addon.ingress_stream || false;
        document.getElementById('panel_icon').value = addon.panel_icon || 'mdi:link-variant';
        
        let webuiPort = '';
        if (addon.webui) {
            const match = addon.webui.match(/\[PORT:(\d+)\]/);
            if (match) webuiPort = match[1];
        }
        document.getElementById('web_ui_port').value = webuiPort;
        
        document.getElementById('backup').checked = addon.backup;
        
        document.getElementById('ingressOptions').style.display = addon.ingress ? 'block' : 'none';
        document.getElementById('webUiPortContainer').style.display = addon.ingress ? 'none' : 'block';
        
        // Ports laden
        document.getElementById('portsContainer').innerHTML = '';
        if (addon.ports && addon.ports.length > 0) {
            addon.ports.forEach(p => {
                addPortMapping(p.container, p.host);
            });
        }

        // Map laden
        document.getElementById('mapContainer').innerHTML = '';
        if (addon.map && addon.map.length > 0) {
            addon.map.forEach(m => {
                const parts = m.split(':');
                if (parts.length === 2) {
                    addMapMapping(parts[0], parts[1]);
                } else {
                    addMapMapping(parts[0], 'rw');
                }
            });
        }

        // Env vars laden
        document.getElementById('envVarsContainer').innerHTML = '';
        if (addon.env_vars && addon.env_vars.length > 0) {
            addon.env_vars.forEach(v => {
                addEnvVar(v.key, v.value, v.userEditable);
            });
        }
        
        document.getElementById('addonSelection').style.display = 'none';
        document.getElementById('converterForm').style.display = 'block';
        document.getElementById('cancelBtn').style.display = 'block';
    }

    async function deleteAddon(slug) {
        if (confirm(`M√∂chtest du das Add-on "${slug}" wirklich l√∂schen? Dieser Vorgang kann nicht r√ºckg√§ngig gemacht werden.`)) {
            try {
                const response = await fetch(`/addons/${slug}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.status === 'success') {
                    loadAddons();
                } else {
                    alert('Fehler beim L√∂schen: ' + result.message);
                }
            } catch (error) {
                alert('Ein Fehler ist aufgetreten: ' + error.message);
            }
        }
    }

    async function openSettings() {
        document.getElementById('addonSelection').style.display = 'none';
        document.getElementById('converterForm').style.display = 'none';
        document.getElementById('settingsView').style.display = 'block';
        document.getElementById('cancelBtn').style.display = 'none';
        
        const response = await fetch('/settings');
        const settings = await response.json();
        document.getElementById('repo_name').value = settings.name;
        document.getElementById('repo_maintainer').value = settings.maintainer;
    }

    function closeSettings() {
        document.getElementById('settingsView').style.display = 'none';
        document.getElementById('addonSelection').style.display = 'block';
    }

    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            name: document.getElementById('repo_name').value,
            maintainer: document.getElementById('repo_maintainer').value
        };
        const response = await fetch('/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.status === 'success') {
            document.getElementById('settingsResult').style.display = 'block';
            setTimeout(() => {
                document.getElementById('settingsResult').style.display = 'none';
                closeSettings();
            }, 1500);
        }
    });

    async function selfConvert() {
        if (!confirm('M√∂chtest du den HAOS Add-on Converter als Add-on f√ºr Home Assistant exportieren? Die Version wird automatisch hochgez√§hlt.')) {
            return;
        }
        
        try {
            const response = await fetch('/self-convert', {
                method: 'POST'
            });
            const result = await response.json();
            
            if (result.status === 'success') {
                alert('Add-on erfolgreich erstellt in: ' + result.path);
                loadAddons();
            } else {
                alert('Fehler: ' + result.message);
            }
        } catch (e) {
            alert('Ein Fehler ist aufgetreten: ' + e.message);
        }
    }

    loadAddons();
</script>

</body>
</html>
