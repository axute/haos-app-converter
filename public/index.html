<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HA Add-on Converter (PHP)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü™Ñ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    <style>
        :root {
            --ha-primary-color: #03a9f4;
            --ha-accent-color: #ff9800;
            --ha-card-background: #ffffff;
            --ha-background-color: #f5f5f5;
            --ha-sidebar-background: #1c1c1c;
            --ha-header-background: #101e24;
            --ha-text-color: #212121;
            --ha-secondary-text-color: #727272;
            --border-radius: 12px;
        }
        body { 
            background-color: var(--ha-background-color); 
            font-family: 'Roboto', sans-serif;
            color: var(--ha-text-color);
        }
        .header-bar {
            background-color: var(--ha-header-background);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        .converter-container { 
            max-width: 1000px; 
            margin: 0 auto 30px auto; 
            background: transparent; 
            padding: 0;
        }
        .ha-card {
            background: var(--ha-card-background);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 1px 5px 0 rgba(0,0,0,0.12), 0 3px 1px -2px rgba(0,0,0,0.2);
            padding: 24px;
            margin-bottom: 24px;
            border: none;
        }
        .ha-card-header {
            font-size: 24px;
            font-weight: 400;
            margin-bottom: 16px;
            color: var(--ha-text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn-ha-primary {
            background-color: var(--ha-primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-ha-primary:hover {
            background-color: #039be5;
            color: white;
        }
        .btn-ha-outline {
            background-color: transparent;
            color: var(--ha-primary-color);
            border: 1px solid var(--ha-primary-color);
            border-radius: 4px;
            padding: 7px 15px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .btn-ha-outline:hover {
            background-color: rgba(3, 169, 244, 0.1);
            color: var(--ha-primary-color);
        }
        .step { display: none; }
        .step.active { display: block; }
        /* EasyMDE dark mode / bootstrap consistency */
        .editor-toolbar { background: #f8f9fa; border-color: #dee2e6; border-radius: 4px 4px 0 0; }
        .CodeMirror { border-color: #dee2e6; border-radius: 0 0 4px 4px; }
        .accordion-button:not(.collapsed) { background-color: rgba(3, 169, 244, 0.1); color: var(--ha-primary-color); box-shadow: none; }
        .accordion-button:focus { border-color: var(--ha-primary-color); box-shadow: 0 0 0 0.25rem rgba(3, 169, 244, 0.25); }
        .accordion-item { border-radius: var(--border-radius) !important; overflow: hidden; margin-bottom: 16px; border: 1px solid #e0e0e0; box-shadow: 0 2px 2px rgba(0,0,0,0.05); }
        .accordion-button { font-weight: 500; font-size: 1.1rem; }
        .form-label { font-weight: 500; color: var(--ha-secondary-text-color); font-size: 0.9rem; }
        .form-control:focus, .form-select:focus { border-color: var(--ha-primary-color); box-shadow: 0 0 0 0.25rem rgba(3, 169, 244, 0.25); }
        .badge.bg-info { background-color: var(--ha-primary-color) !important; color: white !important; }
        .list-group-item { border-left: none; border-right: none; padding: 16px; border-color: #eeeeee; }
        .list-group-item:first-child { border-top: none; }
        .list-group-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

<div class="header-bar">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <span class="mdi mdi-auto-fix me-2" style="font-size: 24px;"></span>
            <h2 class="mb-0" style="font-weight: 400;">HA Add-on Converter</h2>
        </div>
        <button type="button" id="cancelBtn" class="btn btn-outline-light btn-sm" style="display:none;" onclick="cancelConverter()">Cancel</button>
    </div>
</div>

<div class="container">
    <div class="converter-container">
        
        <div id="addonSelection" class="mb-4">
            <div class="ha-card">
                <div class="ha-card-header">
                    <span>Existing Add-ons</span>
                </div>
                <div id="addonList" class="list-group list-group-flush mb-3">
                    <!-- Will be filled dynamically -->
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <div>
                        <button type="button" class="btn btn-ha-primary me-2" onclick="startNew()">
                            <span class="mdi mdi-plus me-1"></span>Create New Add-on
                        </button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-ha-outline" onclick="selfConvert()">
                                <span class="mdi mdi-export me-1"></span>Export Converter
                            </button>
                            <button type="button" class="btn btn-ha-outline dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" onmouseenter="loadTags(this)">
                                <span class="visually-hidden">Toggle Dropdown</span>
                            </button>
                            <ul class="dropdown-menu" id="tagList">
                                <li><h6 class="dropdown-header">Choose Version</h6></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="selfConvert('latest')">latest (default)</a></li>
                            </ul>
                        </div>
                    </div>
                    <button type="button" class="btn btn-ha-outline" onclick="openSettings()">
                        <span class="mdi mdi-cog me-1"></span>Settings
                    </button>
                </div>
            </div>
        </div>

        <form id="converterForm" style="display:none;">
            <div id="converterContent" class="ha-card">
                <div class="accordion" id="formAccordion">
                    
                    <!-- Section 1: Basic Information -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBasic">
                                1. Basic Information
                            </button>
                        </h2>
                        <div id="collapseBasic" class="accordion-collapse collapse show" data-bs-parent="#formAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="name" class="form-label">Add-on Name</label>
                                        <input type="text" class="form-control" id="name" required placeholder="e.g. My Awesome Tool">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="version" class="form-label">Version</label>
                                        <input type="text" class="form-control" id="version" value="1.0.0">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description (Short)</label>
                                    <input type="text" class="form-control" id="description" placeholder="Short summary for the list">
                                </div>

                                <div class="mb-3">
                                    <label for="long_description" class="form-label">Long Description (Markdown / README.md)</label>
                                    <textarea class="form-control" id="long_description" rows="10" placeholder="Detailed description, installation instructions, etc. Supports Markdown."></textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-5">
                                        <div class="mb-3">
                                            <label for="image" class="form-label">Docker Image Name</label>
                                            <input type="text" class="form-control" id="image" required placeholder="e.g. nginx or alpine" onchange="detectPM()">
                                            <div class="form-text">The image name (without tag).</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="image_tag" class="form-label">Tag</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="image_tag" list="imageTagOptions" placeholder="latest" onchange="detectPM()">
                                                <button class="btn btn-outline-secondary" type="button" id="btnFetchTags" onclick="fetchImageTags()">
                                                    <span id="tagLoader" class="spinner-border spinner-border-sm" role="status" style="display:none;"></span>
                                                    <span class="mdi mdi-magnify"></span>
                                                </button>
                                            </div>
                                            <datalist id="imageTagOptions"></datalist>
                                            <div class="form-text">e.g. latest, 3.14</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Detected Package Manager</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="detected_pm" readonly placeholder="unknown">
                                                <button class="btn btn-outline-secondary" type="button" onclick="detectPM()"><span class="mdi mdi-refresh"></span></button>
                                            </div>
                                            <div class="form-text">Detected via crane.</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="icon_file" class="form-label">Icon File (PNG)</label>
                                            <input type="file" class="form-control" id="icon_file" accept="image/png">
                                            <div id="icon_preview" class="mt-2" style="display:none;">
                                                <img src="" alt="Preview" style="max-width: 64px; max-height: 64px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Ingress & UI -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIngress">
                                2. Ingress & Web UI
                            </button>
                        </h2>
                        <div id="collapseIngress" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                            <div class="accordion-body">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="ingress">
                                    <label class="form-check-label" for="ingress">
                                        Enable Home Assistant Ingress
                                    </label>
                                </div>

                                <div id="ingressOptions" style="display:none;" class="p-3 border rounded mb-3 bg-light">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="ingress_port" class="form-label">Internal Web Port (Ingress)</label>
                                            <input type="number" class="form-control" id="ingress_port" value="80">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="panel_icon" class="form-label">Panel Icon (MDI)</label>
                                            <input type="text" class="form-control" id="panel_icon" placeholder="mdi:link-variant">
                                        </div>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="ingress_stream">
                                        <label class="form-check-label" for="ingress_stream">
                                            Enable Ingress Stream
                                        </label>
                                    </div>
                                </div>

                                <div id="webUiPortContainer" class="mb-3">
                                    <label for="web_ui_port" class="form-label">Web UI Port (without Ingress)</label>
                                    <input type="number" class="form-control" id="web_ui_port" placeholder="e.g. 8080">
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="backup">
                                    <label class="form-check-label" for="backup">
                                        Enable Backup Support
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Advanced Configuration -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdvanced">
                                3. Environment, Ports & Storage
                            </button>
                        </h2>
                        <div id="collapseAdvanced" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <h5>Environment Variables</h5>
                                        <div class="alert alert-info py-2 small">
                                            <strong>Note:</strong> Checkbox enables HA GUI editing.
                                        </div>
                                        <div id="envVarsContainer">
                                            <!-- Dynamic Env Variables -->
                                        </div>
                                        <div id="envWarning" class="alert alert-warning py-2 small mt-2" style="display:none;">
                                            <strong>‚ö†Ô∏è Risk:</strong> Enabling editable variables uses a wrapper script. This may cause issues with complex entrypoints.
                                        </div>
                                        <button type="button" class="btn btn-sm btn-ha-outline" onclick="addEnvVar()"><span class="mdi mdi-plus me-1"></span>Add Variable</button>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <h5>Port Mappings</h5>
                                        <div id="portsContainer">
                                            <!-- Dynamic Port Mappings -->
                                        </div>
                                        <button type="button" class="btn btn-sm btn-ha-outline" onclick="addPortMapping()"><span class="mdi mdi-plus me-1"></span>Add Port</button>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <h5>Storage Mappings (Map)</h5>
                                    <div id="mapContainer">
                                        <!-- Dynamic Map Mappings -->
                                    </div>
                                    <button type="button" class="btn btn-sm btn-ha-outline" onclick="addMapMapping()"><span class="mdi mdi-plus me-1"></span>Add Mapping</button>
                                    <div class="form-text">Allows access to HA folders (e.g. config, ssl, share, media).</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>
                
                <div id="submitSection" class="d-grid gap-2">
                    <button type="submit" id="saveBtn" class="btn btn-ha-primary btn-lg"><span class="mdi mdi-content-save me-1"></span>Create / Save Add-on</button>
                </div>

                <div id="updateSection" style="display:none;">
                    <label class="form-label d-block mb-2">Update Add-on (Version Update)</label>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <button type="button" class="btn btn-ha-outline w-100" onclick="submitUpdate('major')">Major Update</button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-ha-outline w-100" onclick="submitUpdate('minor')">Minor Update</button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-ha-primary w-100" onclick="submitUpdate('fix')">Fix Update</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div id="result" class="mt-4" style="display:none;">
            <!-- Will be filled dynamically -->
        </div>

        <div id="settingsView" style="display:none;">
            <div class="ha-card">
                <div class="ha-card-header">
                    <span>Global Repository Settings</span>
                    <button type="button" class="btn btn-ha-outline btn-sm" onclick="closeSettings()">Back</button>
                </div>
                <form id="settingsForm">
                    <div class="mb-3">
                        <label for="repo_name" class="form-label">Repository Name</label>
                        <input type="text" class="form-control" id="repo_name" required>
                        <div class="form-text">The name of your Home Assistant add-on repository.</div>
                    </div>
                    <div class="mb-3">
                        <label for="repo_maintainer" class="form-label">Maintainer</label>
                        <input type="text" class="form-control" id="repo_maintainer" required>
                        <div class="form-text">Your name or pseudonym as maintainer.</div>
                    </div>
                    <button type="submit" class="btn btn-ha-primary">Save Settings</button>
                </form>
                <div id="settingsResult" class="mt-3" style="display:none;">
                    <div class="alert alert-success">Settings saved!</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Confirmations -->
<div class="modal fade" id="haConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow" style="border-radius: var(--border-radius);">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="haConfirmTitle">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-4" id="haConfirmMessage">
                Are you sure?
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-ha-outline btn-sm px-3" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-ha-primary btn-sm px-4" id="haConfirmBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Ingress support: Detect base path from current location
    // window.location.pathname might be something like /hassio/ingress/21c7eb11_haos_addon_converter/
    // We want the part before the trailing slash, but only if it's not just /
    const currentPath = window.location.pathname;
    const basePath = currentPath.endsWith('/') 
        ? currentPath.slice(0, -1) 
        : currentPath;

    console.log('Detected basePath:', basePath);

    // HA Confirm Modal Helper
    const haConfirmModal = new bootstrap.Modal(document.getElementById('haConfirmModal'));
    let confirmCallback = null;
    function haConfirm(message, callback, title = 'Confirm Action', btnText = 'Confirm', btnClass = 'btn-ha-primary') {
        document.getElementById('haConfirmMessage').innerText = message;
        document.getElementById('haConfirmTitle').innerText = title;
        const confirmBtn = document.getElementById('haConfirmBtn');
        confirmBtn.innerText = btnText;
        confirmBtn.className = 'btn btn-sm px-4 ' + btnClass;
        confirmCallback = callback;
        haConfirmModal.show();
    }
    document.getElementById('haConfirmBtn').addEventListener('click', () => {
        if (confirmCallback) confirmCallback();
        haConfirmModal.hide();
    });

    let iconBase64 = '';
    let isEditing = false;
    let originalVersion = '1.0.0';

    // Initialize EasyMDE
    const easyMDE = new EasyMDE({
        element: document.getElementById('long_description'),
        spellChecker: false,
        autosave: {
            enabled: false,
        },
        status: false,
        placeholder: "Detailed description, installation instructions, etc. Supports Markdown.",
        minHeight: "200px"
    });

    document.getElementById('icon_file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                iconBase64 = event.target.result;
                document.getElementById('icon_preview').style.display = 'block';
                document.getElementById('icon_preview').querySelector('img').src = iconBase64;
            };
            reader.readAsDataURL(file);
        }
    });

    function addEnvVar(key = '', value = '', editable = false) {
        const container = document.getElementById('envVarsContainer');
        const div = document.createElement('div');
        div.className = 'input-group mb-2 env-var-row';
        div.innerHTML = `
            <div class="input-group-text">
                <input class="form-check-input mt-0 env-editable" type="checkbox" value="" title="Editable in HA GUI" ${editable ? 'checked' : ''} onchange="checkEnvWarnings()">
            </div>
            <input type="text" class="form-control env-key" placeholder="KEY" value="${key}">
            <input type="text" class="form-control env-value" placeholder="VALUE" value="${value}">
            <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove(); checkEnvWarnings();">√ó</button>
        `;
        container.appendChild(div);
        checkEnvWarnings();
    }

    function checkEnvWarnings() {
        const editables = document.querySelectorAll('.env-editable:checked');
        document.getElementById('envWarning').style.display = editables.length > 0 ? 'block' : 'none';
    }

    function getEnvVars() {
        const rows = document.querySelectorAll('.env-var-row');
        const vars = [];
        rows.forEach(row => {
            const key = row.querySelector('.env-key').value.trim();
            const value = row.querySelector('.env-value').value;
            const editable = row.querySelector('.env-editable').checked;
            if (key) {
                vars.push({ key, value, editable });
            }
        });
        return vars;
    }

    function addPortMapping(containerPort = '', hostPort = '') {
        const container = document.getElementById('portsContainer');
        const div = document.createElement('div');
        div.className = 'input-group mb-2 port-mapping-row';
        div.innerHTML = `
            <input type="number" class="form-control port-container" placeholder="Container Port" value="${containerPort}">
            <span class="input-group-text">‚Üí</span>
            <input type="number" class="form-control port-host" placeholder="Host Port" value="${hostPort}">
            <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">√ó</button>
        `;
        container.appendChild(div);
    }

    function getPortMappings() {
        const rows = document.querySelectorAll('.port-mapping-row');
        const ports = [];
        rows.forEach(row => {
            const container = row.querySelector('.port-container').value;
            const host = row.querySelector('.port-host').value;
            if (container && host) {
                ports.push({ container: parseInt(container), host: parseInt(host) });
            }
        });
        return ports;
    }

    function addMapMapping(folder = 'config', mode = 'rw') {
        const container = document.getElementById('mapContainer');
        const div = document.createElement('div');
        div.className = 'input-group mb-2 map-row';
        div.innerHTML = `
            <select class="form-select map-folder">
                <option value="config" ${folder === 'config' ? 'selected' : ''}>config</option>
                <option value="ssl" ${folder === 'ssl' ? 'selected' : ''}>ssl</option>
                <option value="share" ${folder === 'share' ? 'selected' : ''}>share</option>
                <option value="media" ${folder === 'media' ? 'selected' : ''}>media</option>
                <option value="addons" ${folder === 'addons' ? 'selected' : ''}>addons</option>
                <option value="backup" ${folder === 'backup' ? 'selected' : ''}>backup</option>
            </select>
            <select class="form-select map-mode" style="max-width: 100px;">
                <option value="rw" ${mode === 'rw' ? 'selected' : ''}>RW</option>
                <option value="ro" ${mode === 'ro' ? 'selected' : ''}>RO</option>
            </select>
            <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">√ó</button>
        `;
        container.appendChild(div);
    }

    function getMapMappings() {
        const rows = document.querySelectorAll('.map-row');
        const maps = [];
        rows.forEach(row => {
            const folder = row.querySelector('.map-folder').value;
            const mode = row.querySelector('.map-mode').value;
            maps.push(`${folder}:${mode}`);
        });
        return maps;
    }

    document.getElementById('ingress').addEventListener('change', (e) => {
        document.getElementById('ingressOptions').style.display = e.target.checked ? 'block' : 'none';
        document.getElementById('webUiPortContainer').style.display = e.target.checked ? 'none' : 'block';
    });

    async function submitUpdate(type) {
        let parts = originalVersion.split('.').map(x => parseInt(x) || 0);
        while (parts.length < 3) parts.push(0);

        if (type === 'major') {
            parts[0]++;
            parts[1] = 0;
            parts[2] = 0;
        } else if (type === 'minor') {
            parts[1]++;
            parts[2] = 0;
        } else if (type === 'fix') {
            parts[2]++;
        }

        const newVersion = parts.join('.');
        document.getElementById('version').value = newVersion;
        
        // Formular absenden
        document.getElementById('converterForm').dispatchEvent(new Event('submit'));
    }

    async function detectPM() {
        const image = document.getElementById('image').value.trim();
        const tag = document.getElementById('image_tag').value.trim() || 'latest';
        if (!image) return;
        
        const pmInput = document.getElementById('detected_pm');
        pmInput.value = 'detecting...';
        
        try {
            const response = await fetch(`${basePath}/detect-pm?image=${encodeURIComponent(image)}&tag=${encodeURIComponent(tag)}`);
            const data = await response.json();
            pmInput.value = data.pm || 'unknown';
        } catch (e) {
            console.error('Error detecting PM', e);
            pmInput.value = 'error';
        }
    }

    async function fetchImageTags() {
        const image = document.getElementById('image').value.trim();
        if (!image) return;
        
        const btn = document.getElementById('btnFetchTags');
        const loader = document.getElementById('tagLoader');
        const datalist = document.getElementById('imageTagOptions');
        
        btn.disabled = true;
        loader.style.display = 'inline-block';
        datalist.innerHTML = '<option value="loading...">';
        
        try {
            const response = await fetch(`${basePath}/image-tags?image=${encodeURIComponent(image)}`);
            const tags = await response.json();
            datalist.innerHTML = '';
            tags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                // Tags with .sig or sha256- are usually not what a human wants to pick, but we keep them
                if (tag.endsWith('.sig') || tag.startsWith('sha256-')) {
                    option.textContent = tag + ' (Signature/Hash)';
                }
                datalist.appendChild(option);
            });
            datalist.dataset.image = image;
            // PM nach dem Abrufen der Tags ebenfalls erkennen (da evtl. 'latest' gew√§hlt wurde)
            detectPM();
        } catch (e) {
            console.error('Error fetching tags', e);
            datalist.innerHTML = '';
            alert('Failed to fetch tags for image: ' + image);
        } finally {
            btn.disabled = false;
            loader.style.display = 'none';
        }
    }

    document.getElementById('converterForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            name: document.getElementById('name').value,
            description: document.getElementById('description').value,
            long_description: easyMDE.value(),
            icon_file: iconBase64,
            image: document.getElementById('image').value,
            image_tag: document.getElementById('image_tag').value,
            version: document.getElementById('version').value,
            ingress: document.getElementById('ingress').checked,
            ingress_port: parseInt(document.getElementById('ingress_port').value),
            ingress_stream: document.getElementById('ingress_stream').checked,
            panel_icon: document.getElementById('panel_icon').value || 'mdi:link-variant',
            webui_port: document.getElementById('web_ui_port').value ? parseInt(document.getElementById('web_ui_port').value) : null,
            backup: document.getElementById('backup').checked,
            detected_pm: document.getElementById('detected_pm').value,
            ports: getPortMappings(),
            map: getMapMappings(),
            env_vars: getEnvVars()
        };

        const response = await fetch(`${basePath}/generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.status === 'success') {
            const summary = `
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title text-success">Success!</h5>
                        <p class="card-text">Add-on has been created/updated.</p>
                        <p class="mb-0"><strong>Path:</strong> <code id="resultPath">${result.path}</code></p>
                    </div>
                </div>
            `;
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = summary;
            resultDiv.style.display = 'block';
            document.getElementById('converterForm').style.display = 'none';
            document.getElementById('addonSelection').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
            setTimeout(() => location.href = basePath || '/', 3000); // Reload after 3 seconds to update list
        } else {
            alert('Error: ' + result.message);
        }
    });

    async function loadAddons() {
        const response = await fetch(`${basePath}/addons`);
        const addons = await response.json();
        const list = document.getElementById('addonList');
        if (addons.length === 0) {
            list.innerHTML = '<div class="list-group-item">No add-ons found</div>';
            return;
        }
        list.innerHTML = addons.map(addon => {
            const isSelf = addon.slug === 'haos_addon_converter';
            const iconHtml = addon.has_local_icon 
                ? `<img src="${basePath}/addons/${addon.slug}/icon.png" style="width: 24px; height: 24px;" class="me-2">` 
                : '';
            return `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="me-3 text-center" style="width: 40px; font-size: 24px;">
                        ${addon.has_local_icon 
                            ? `<img src="${basePath}/addons/${addon.slug}/icon.png" style="width: 32px; height: 32px;">` 
                            : 'üì¶'} 
                    </div>
                    <div>
                        <strong>${addon.name}</strong>
                        ${addon.detected_pm ? `<span class="badge bg-info text-dark rounded-pill ms-1" style="font-size: 0.7rem;">${addon.detected_pm}</span>` : ''}
                        <br>
                        <small class="text-muted d-block">${addon.description}</small>
                        <small class="text-muted">Version: ${addon.version} | Image: <code>${addon.image}</code></small>
                    </div>
                </div>
                ${isSelf ? 
                    '<span class="badge bg-secondary rounded-pill">System</span>' : 
                    `<div>
                        <button type="button" class="btn btn-sm btn-ha-outline rounded-pill me-1" onclick="editAddon('${addon.slug}')">
                            <span class="mdi mdi-pencil"></span>
                        </button>
                        <button type="button" class="btn btn-sm btn-ha-outline rounded-pill text-danger border-danger" onclick="deleteAddon('${addon.slug}')">
                            <span class="mdi mdi-delete"></span>
                        </button>
                    </div>`
                }
            </div>
        `}).join('');
    }

    function startNew() {
        isEditing = false;
        document.getElementById('addonSelection').style.display = 'none';
        document.getElementById('converterForm').style.display = 'block';
        document.getElementById('cancelBtn').style.display = 'block';
        
        document.getElementById('submitSection').style.display = 'grid';
        document.getElementById('updateSection').style.display = 'none';
        document.getElementById('version').readOnly = false;

        const accordion = document.getElementById('formAccordion');
        const firstItem = accordion.querySelector('.accordion-collapse');
        const bootstrapCollapse = new bootstrap.Collapse(firstItem, { show: true });
        const otherItems = accordion.querySelectorAll('.accordion-collapse:not(.show)');
        otherItems.forEach(item => {
            const collapse = bootstrap.Collapse.getInstance(item);
            if (collapse) collapse.hide();
            else item.classList.remove('show');
        });

        document.getElementById('converterForm').reset();
        document.getElementById('image').value = '';
        document.getElementById('image_tag').value = '';
        document.getElementById('imageTagOptions').innerHTML = '';
        easyMDE.value('');
        iconBase64 = '';
        document.getElementById('icon_preview').style.display = 'none';
        document.getElementById('icon_preview').querySelector('img').src = '';
        document.getElementById('ingressOptions').style.display = 'none';
        document.getElementById('webUiPortContainer').style.display = 'block';
        document.getElementById('web_ui_port').value = '';
        document.getElementById('panel_icon').value = 'mdi:link-variant';
        document.getElementById('envVarsContainer').innerHTML = '';
        document.getElementById('portsContainer').innerHTML = '';
        document.getElementById('mapContainer').innerHTML = '';
    }

    function cancelConverter() {
        haConfirm('Do you really want to cancel the process? All unsaved changes will be lost.', () => {
            document.getElementById('addonSelection').style.display = 'block';
            document.getElementById('converterForm').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
            loadAddons();
        }, 'Cancel Process', 'Yes, Cancel');
    }

    async function editAddon(slug) {
        isEditing = true;
        const response = await fetch(`${basePath}/addons/${slug}`);
        const addon = await response.json();
        
        document.getElementById('name').value = addon.name;
        document.getElementById('description').value = addon.description;
        easyMDE.value(addon.long_description || '');
        
        iconBase64 = addon.icon_file || '';
        if (iconBase64) {
            document.getElementById('icon_preview').style.display = 'block';
            document.getElementById('icon_preview').querySelector('img').src = iconBase64;
        } else {
            document.getElementById('icon_preview').style.display = 'none';
        }

        document.getElementById('image').value = addon.image;
        document.getElementById('image_tag').value = addon.image_tag || 'latest';
        document.getElementById('version').value = addon.version;
        originalVersion = addon.version || '1.0.0';
        document.getElementById('version').readOnly = true;

        document.getElementById('submitSection').style.display = 'none';
        document.getElementById('updateSection').style.display = 'block';
        document.getElementById('ingress').checked = addon.ingress;
        document.getElementById('ingress_port').value = addon.ingress_port;
        document.getElementById('ingress_stream').checked = addon.ingress_stream || false;
        document.getElementById('panel_icon').value = addon.panel_icon || 'mdi:link-variant';
        
        let webuiPort = '';
        if (addon.webui) {
            const match = addon.webui.match(/\[PORT:(\d+)\]/);
            if (match) webuiPort = match[1];
        }
        document.getElementById('web_ui_port').value = webuiPort;
        
        document.getElementById('backup').checked = addon.backup;
        
        document.getElementById('detected_pm').value = addon.detected_pm || 'unknown';
        
        document.getElementById('ingressOptions').style.display = addon.ingress ? 'block' : 'none';
        document.getElementById('webUiPortContainer').style.display = addon.ingress ? 'none' : 'block';
        
        // Ports laden
        document.getElementById('portsContainer').innerHTML = '';
        if (addon.ports && addon.ports.length > 0) {
            addon.ports.forEach(p => {
                addPortMapping(p.container, p.host);
            });
        }

        // Map laden
        document.getElementById('mapContainer').innerHTML = '';
        if (addon.map && addon.map.length > 0) {
            addon.map.forEach(m => {
                const parts = m.split(':');
                if (parts.length === 2) {
                    addMapMapping(parts[0], parts[1]);
                } else {
                    addMapMapping(parts[0], 'rw');
                }
            });
        }

        // Env vars laden
        document.getElementById('envVarsContainer').innerHTML = '';
        if (addon.env_vars && addon.env_vars.length > 0) {
            addon.env_vars.forEach(v => {
                addEnvVar(v.key, v.value, v.editable);
            });
        }
        
        document.getElementById('addonSelection').style.display = 'none';
        document.getElementById('converterForm').style.display = 'block';
        document.getElementById('cancelBtn').style.display = 'block';
    }

    async function deleteAddon(slug) {
        haConfirm(`Do you really want to delete the add-on "${slug}"? This action cannot be undone.`, async () => {
            try {
                const response = await fetch(`${basePath}/addons/${slug}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.status === 'success') {
                    loadAddons();
                } else {
                    alert('Error during deletion: ' + result.message);
                }
            } catch (error) {
                alert('An error occurred: ' + error.message);
            }
        }, 'Delete Add-on', 'Delete', 'btn-danger');
    }

    async function openSettings() {
        document.getElementById('addonSelection').style.display = 'none';
        document.getElementById('converterForm').style.display = 'none';
        document.getElementById('settingsView').style.display = 'block';
        document.getElementById('cancelBtn').style.display = 'none';
        
        const response = await fetch(`${basePath}/settings`);
        const settings = await response.json();
        document.getElementById('repo_name').value = settings.name;
        document.getElementById('repo_maintainer').value = settings.maintainer;
    }

    function closeSettings() {
        document.getElementById('settingsView').style.display = 'none';
        document.getElementById('addonSelection').style.display = 'block';
    }

    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            name: document.getElementById('repo_name').value,
            maintainer: document.getElementById('repo_maintainer').value
        };
        const response = await fetch(`${basePath}/settings`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.status === 'success') {
            document.getElementById('settingsResult').style.display = 'block';
            setTimeout(() => {
                document.getElementById('settingsResult').style.display = 'none';
                closeSettings();
            }, 1500);
        }
    });

    async function selfConvert(tag = 'latest') {
        haConfirm(`Do you want to export the HAOS Add-on Converter (Version: ${tag}) as a Home Assistant add-on? The internal version will be incremented automatically.`, async () => {
            try {
                const response = await fetch(`${basePath}/self-convert`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag: tag })
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert('Add-on successfully created in: ' + result.path);
                    loadAddons();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (e) {
                alert('An error occurred: ' + e.message);
            }
        }, 'Export Converter', 'Export');
    }

    async function loadTags(btn) {
        const list = document.getElementById('tagList');
        // Only load if it's the first time or we want to refresh
        if (list.dataset.loaded === 'true') return;
        
        try {
            const response = await fetch(`${basePath}/tags`);
            const tags = await response.json();
            
            // Clear current list after header and divider
            const header = list.querySelector('.dropdown-header');
            const divider = list.querySelector('.dropdown-divider');
            list.innerHTML = '';
            list.appendChild(header.parentElement === list ? header : header.closest('li'));
            list.appendChild(divider.parentElement === list ? divider : divider.closest('li'));
            
            tags.forEach(tag => {
                const li = document.createElement('li');
                li.innerHTML = `<a class="dropdown-item" href="#" onclick="selfConvert('${tag}')">${tag}</a>`;
                list.appendChild(li);
            });
            list.dataset.loaded = 'true';
        } catch (e) {
            console.error('Error loading tags', e);
        }
    }

    loadAddons();
</script>

</body>
</html>
