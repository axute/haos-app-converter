<form id="converterForm" style="display:none;">
    <div id="converterContent" class="ha-card">
        <div class="accordion" id="formAccordion">
            
            <!-- Section 1: Basic Information -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBasic">
                        1. Basic Information
                    </button>
                </h2>
                <div id="collapseBasic" class="accordion-collapse collapse show" data-bs-parent="#formAccordion">
                    <div class="accordion-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="name" class="form-label">Add-on Name</label>
                                <input type="text" class="form-control" id="name" required placeholder="e.g. My Awesome Tool">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="version" class="form-label">Version</label>
                                <input type="text" class="form-control" id="version" value="1.0.0">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description (Short)</label>
                            <input type="text" class="form-control" id="description" placeholder="Short summary for the list">
                        </div>

                        <div class="mb-3">
                            <label for="long_description" class="form-label">Long Description (Markdown / README.md)</label>
                            <textarea class="form-control" id="long_description" rows="10" placeholder="Detailed description, installation instructions, etc. Supports Markdown."></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-5">
                                <div class="mb-3">
                                    <label for="image" class="form-label">Docker Image Name</label>
                                    <input type="text" class="form-control" id="image" required placeholder="e.g. nginx or alpine" onchange="detectPM()">
                                    <div class="form-text">The image name (without tag).</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="image_tag" class="form-label">Tag</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="image_tag" list="imageTagOptions" placeholder="latest" onchange="detectPM()">
                                        <button class="btn btn-outline-secondary" type="button" id="btnFetchTags" onclick="fetchImageTags()">
                                            <span id="tagLoader" class="spinner-border spinner-border-sm" role="status" style="display:none;"></span>
                                            <span class="mdi mdi-magnify"></span>
                                        </button>
                                    </div>
                                    <datalist id="imageTagOptions"></datalist>
                                    <div class="form-text">e.g. latest, 3.14</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Detected Package Manager</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="detected_pm" readonly placeholder="unknown">
                                        <button class="btn btn-outline-secondary" type="button" id="btnDetectPM" onclick="detectPM(true)">
                                            <span id="pmLoader" class="spinner-border spinner-border-sm" role="status" style="display:none;"></span>
                                            <span class="mdi mdi-refresh"></span>
                                        </button>
                                    </div>
                                    <div class="form-text">Detected via crane. <span id="pmSupportInline" class="ms-2"></span></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="icon_file" class="form-label">Icon File (PNG)</label>
                                    <input type="file" class="form-control" id="icon_file" accept="image/png">
                                    <div id="icon_preview" class="mt-2" style="display:none;">
                                        <img src="" alt="Preview" style="max-width: 64px; max-height: 64px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Ingress & UI -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIngress">
                        2. Ingress & Web UI
                    </button>
                </h2>
                <div id="collapseIngress" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                    <div class="accordion-body">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="ingress">
                            <label class="form-check-label" for="ingress">
                                Enable Home Assistant Ingress
                            </label>
                        </div>

                        <div id="ingressOptions" style="display:none;" class="p-3 border rounded mb-3 bg-light">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="ingress_port" class="form-label">Internal Web Port (Ingress)</label>
                                    <input type="number" class="form-control" id="ingress_port" value="80">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="panel_icon" class="form-label">Panel Icon (MDI)</label>
                                    <input type="text" class="form-control" id="panel_icon" placeholder="mdi:link-variant">
                                </div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="ingress_stream">
                                <label class="form-check-label" for="ingress_stream">
                                    Enable Ingress Stream
                                </label>
                            </div>
                        </div>

                        <div id="webUiPortContainer" class="mb-3">
                            <label for="web_ui_port" class="form-label">Web UI Port (without Ingress)</label>
                            <input type="number" class="form-control" id="web_ui_port" placeholder="e.g. 8080">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Backup Support</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="backup" id="backup_disabled" value="disabled" checked>
                                <label class="form-check-label" for="backup_disabled">
                                    <strong>Disabled</strong> - No backup support for this add-on.
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="backup" id="backup_hot" value="hot">
                                <label class="form-check-label" for="backup_hot">
                                    <strong>Hot Backup</strong> - The add-on continues to run during the backup. Data must be in a consistent state on disk.
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="backup" id="backup_cold" value="cold">
                                <label class="form-check-label" for="backup_cold">
                                    <strong>Cold Backup</strong> - The add-on is stopped before the backup and restarted afterwards. Safer for databases.
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Port Mappings</label>
                                <button type="button" class="btn btn-sm btn-ha-outline" onclick="addPort()">
                                    <span class="mdi mdi-plus"></span> Add Port
                                </button>
                            </div>
                            <div id="portsContainer"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Environment & Config -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConfig">
                        3. Environment & Configuration
                    </button>
                </h2>
                <div id="collapseConfig" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                    <div class="accordion-body">
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Environment Variables</label>
                                <button type="button" class="btn btn-sm btn-ha-outline" onclick="addEnvVar()">
                                    <span class="mdi mdi-plus"></span> Add Variable
                                </button>
                            </div>
                            <div id="envVarsContainer"></div>
                            <div id="envWarning" class="alert alert-warning mt-2" style="display:none;">
                                <span class="mdi mdi-alert"></span> <strong>Note:</strong> Editable environment variables require the user to set them in the Configuration tab of the add-on in Home Assistant.
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Volume Mappings / Mounts</label>
                                <button type="button" class="btn btn-sm btn-ha-outline" onclick="addMap()">
                                    <span class="mdi mdi-plus"></span> Add Mapping
                                </button>
                            </div>
                            <div id="mapContainer"></div>
                            <div class="form-text mt-2">Format: <code>config:/config</code> or <code>share:/share</code></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4: Advanced & Quirks -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdvanced">
                        4. Advanced & Quirks Mode
                    </button>
                </h2>
                <div id="collapseAdvanced" class="accordion-collapse collapse" data-bs-parent="#formAccordion">
                    <div class="accordion-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="quirks_mode" onchange="toggleEditableCheckboxes()">
                            <label class="form-check-label" for="quirks_mode">
                                <strong>Enable Quirks Mode / Custom Entrypoint</strong>
                            </label>
                            <div class="form-text">Allows custom startup scripts and manual overrides. Use only if the default image doesn't work out of the box.</div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="allow_user_env">
                            <label class="form-check-label" for="allow_user_env">
                                <strong>Allow user to create environment variables</strong>
                            </label>
                            <div class="form-text">If enabled, the Home Assistant user can add their own environment variables in the add-on configuration.</div>
                        </div>

                        <div id="startupScriptSection" style="display:none;" class="mb-3">
                            <div class="mb-3">
                                <label for="bashio_version" class="form-label d-flex align-items-center">
                                    Bashio Version
                                    <span id="bashioLoader" class="spinner-border spinner-border-sm ms-2" role="status" style="display:none;">
                                        <span class="visually-hidden">Loading...</span>
                                    </span>
                                </label>
                                <select class="form-select" id="bashio_version">
                                    <option value="" selected disabled>Lade Versionen...</option>
                                </select>
                                <div class="form-text">Wird als <code>HAOS_CONVERTER_BASHIO_VERSION</code> Ã¼bergeben.</div>
                            </div>
                            <label for="startup_script" class="form-label">Custom Startup Script (run.sh)</label>
                            <textarea id="startup_script"></textarea>
                            <div class="form-text mt-2">This script will be executed before the main application starts.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="ha-card-footer mt-4">
            <div id="submitSection" style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button type="submit" id="generateBtn" class="btn btn-ha-primary btn-lg">
                    <span class="mdi mdi-creation me-2"></span>Generate Add-on
                </button>
                <div class="btn-group">
                    <button type="button" class="btn btn-ha-outline btn-lg" onclick="downloadConfig()">
                        <span class="mdi mdi-download me-2"></span>Download Config
                    </button>
                </div>
            </div>
            <div id="updateSection" style="display:none; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button type="submit" id="updateBtn" class="btn btn-ha-primary btn-lg">
                    <span class="mdi mdi-content-save me-2"></span>Save Changes
                </button>
                <button type="button" class="btn btn-ha-outline btn-lg" onclick="cancelConverter()">
                    Cancel
                </button>
            </div>
            
            <div id="result" class="mt-4" style="display:none;">
                <div class="alert alert-success">
                    <h5 class="alert-heading"><span class="mdi mdi-check-circle me-2"></span>Success!</h5>
                    <p id="resultMessage" class="mb-0"></p>
                </div>
                <div id="resultDetails" class="mt-3"></div>
            </div>
            <div id="error" class="mt-4" style="display:none;">
                <div class="alert alert-danger">
                    <h5 class="alert-heading"><span class="mdi mdi-alert-circle me-2"></span>Error</h5>
                    <p id="errorMessage" class="mb-0"></p>
                </div>
            </div>
        </div>
    </div>
</form>
