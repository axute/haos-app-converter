{% if repository is defined and repository is iterable %}
    <div id="repoInfo" class="mb-2 text-muted small" style="padding: 0 16px;">
        {% if repository.name is not empty %}<strong>{{ repository.name }}</strong>{% endif %}
        {% if repository.name is not empty and repository.description is not empty %} ‚Äî {% endif %}
        {% if repository.description is not empty %}{{ repository.description }}{% endif %}
    </div>
{% endif %}

<div id="appList" class="list-group list-group-flush mb-3">
    {% if apps is empty %}
        <div class="list-group-item">No apps found</div>
    {% else %}
        {% for app in apps %}
            {% set isSelf = (app.slug == 'haos_app_converter') %}
            {% set rating = app.security_rating|default(4) %}
            {% set rating_color = (rating <= 2) ? 'danger' : (rating == 3 ? 'warning' : 'success') %}
            <div class="list-group-item">
                <div class="row align-items-start g-3">
                    <div class="col-12 col-lg-4">
                        <div class="d-flex align-items-start">
                            <div class="me-3 text-center flex-shrink-0" style="width: 40px; font-size: 24px;">
                                {% if app.has_local_icon %}
                                    <img src="{{ basePath }}/apps/{{ app.slug }}/icon.png" style="width: 32px; height: 32px;" alt="{{ app.slug }}">
                                {% else %}
                                    üì¶
                                {% endif %}
                                <div class="mt-1">
                                    <span class="badge bg-{{ rating_color }} rounded-pill" style="font-size: 0.65rem;" title="Security Rating: {{ rating }}/6">üõ°Ô∏è {{ rating }}</span>
                                </div>
                            </div>
                            <div class="text-truncate">
                                <strong class="d-block text-truncate" title="{{ app.name }}">{{ app.name }}</strong>
                                <small class="text-muted d-block text-truncate" title="{{ app.description }}">{{ app.description }}</small>
                                <small class="text-muted d-block">Version: {{ app.version }}</small>
                                <div class="d-flex align-items-center flex-wrap gap-1 mt-1">
                                    
                                    {% if app.detected_pm is not empty %}
                                        <span class="badge bg-info text-dark rounded-pill" style="font-size: 0.65rem;">{{ app.detected_pm }}</span>
                                    {% endif %}
                                    {% if app.quirks %}
                                        <span class="badge bg-warning text-dark rounded-pill" style="font-size: 0.65rem;">quirks</span>
                                    {% endif %}
                                    {% if app.apparmor is same as(true) %}
                                        <span class="badge bg-warning text-dark rounded-pill" style="font-size: 0.65rem;" title="AppArmor aktiv (Standard)">apparmor</span>
                                    {% elseif app.apparmor is not empty and app.apparmor is not same as(false) %}
                                        <span class="badge bg-danger text-white rounded-pill" style="font-size: 0.65rem;" title="Custom AppArmor Profile (Experimental): {{ app.apparmor }}">apparmor</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-lg-4">
                        <div class="d-flex align-items-start flex-wrap" style="padding-top: 4px;">
                            <a href="{{ app.image_url }}" target="_blank" class="text-decoration-none text-truncate d-inline-block small" style="max-width: 100%;"><code>{{ app.image }}:{{ app.image_tag }}</code></a>
                            <div id="update-status-{{ app.slug }}"
                                  hx-get="{{ basePath }}/fragments/check-update/{{ app.slug }}"
                                  hx-trigger="load" 
                                  hx-swap="outerHTML"
                                  hx-indicator="this"
                                  class="d-inline-block">
                                <span class="badge bg-light text-muted rounded-pill htmx-indicator" style="font-size: 0.7rem;">
                                    <span class="mdi mdi-loading mdi-spin"></span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-lg-4 text-lg-end">
                        {% if isSelf %}
                            <span class="badge bg-secondary rounded-pill">System</span>
                        {% else %}
                            <div class="d-flex align-items-start justify-content-between justify-content-lg-end flex-wrap gap-2">
                                <div class="form-check form-switch mb-0" style="padding-top: 4px;">
                                    <input class="form-check-input me-1" type="checkbox" id="vf_{{ app.slug }}" {% if app.version_fixation %}checked{% endif %}
                                           onchange="toggleVersionFixation('{{ app.slug }}', this.checked)">
                                    <label class="form-check-label small" for="vf_{{ app.slug }}" title="Version der App an das Docker-Image binden">Version fixieren</label>
                                </div>
                                <div class="btn-group shadow-sm">
                                    <button type="button" class="btn btn-sm btn-ha-outline" title="Info" 
                                            hx-get="{{ basePath }}/fragments/app-details/{{ app.slug }}"
                                            hx-target="#app-info-{{ app.slug }}"
                                            onclick="bootstrap.Collapse.getOrCreateInstance(document.getElementById('app-info-{{ app.slug }}')).toggle()">
                                        <span class="mdi mdi-information-outline"></span>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-ha-outline" title="Download ZIP" onclick="downloadApp('{{ app.slug }}')">
                                        <span class="mdi mdi-download"></span>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-ha-outline" onclick="editApp('{{ app.slug }}')">
                                        <span class="mdi mdi-pencil"></span>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-ha-outline border-danger text-danger-hover" onclick="deleteApp('{{ app.slug }}')">
                                        <span class="mdi mdi-delete"></span>
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div id="app-info-{{ app.slug }}" class="collapse mt-3"></div>
            </div>
        {% endfor %}
    {% endif %}
</div>
